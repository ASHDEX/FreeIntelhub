<%- include('partials/head', { pageTitle: 'Ransomfeed' }) %>

<div class="page-header">
  <h1>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="vertical-align:middle;margin-right:0.5rem;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Ransomfeed
  </h1>
  <p>Live ransomware claim tracker powered by <a href="https://ransomfeed.it" target="_blank" rel="noopener noreferrer">ransomfeed.it</a> &mdash; <strong><%= total %></strong> claims loaded</p>
</div>

<% if (error) { %>
  <div class="alert alert-danger"><%= error %></div>
<% } %>

<!-- Filters -->
<div class="rf-controls">
  <div class="rf-filter-row">
    <label class="rf-filter-label">Group:</label>
    <select id="rf-group-filter" class="rf-select" onchange="applyFilters()">
      <option value="">All Groups (<%= groups.length %>)</option>
      <% groups.forEach(function(g) { %>
        <option value="<%= g %>"<%= activeGroup === g ? ' selected' : '' %>><%= g %></option>
      <% }); %>
    </select>

    <label class="rf-filter-label">Country:</label>
    <select id="rf-country-filter" class="rf-select" onchange="applyFilters()">
      <option value="">All Countries (<%= countries.length %>)</option>
      <% countries.forEach(function(c) { %>
        <option value="<%= c %>"<%= activeCountry === c ? ' selected' : '' %>><%= c %></option>
      <% }); %>
    </select>

    <% if (activeGroup || activeCountry) { %>
      <a href="/ransomfeed" class="btn btn-sm rf-clear-btn">Clear Filters</a>
    <% } %>
  </div>

  <div class="rf-result-count">
    Showing <strong><%= items.length %></strong><%= (activeGroup || activeCountry) ? ' filtered' : '' %> claims
  </div>
</div>

<!-- Stats cards -->
<div class="rf-stats-row">
  <div class="rf-stat-card">
    <span class="rf-stat-number"><%= groups.length %></span>
    <span class="rf-stat-label">Active Groups</span>
  </div>
  <div class="rf-stat-card">
    <span class="rf-stat-number"><%= countries.length %></span>
    <span class="rf-stat-label">Countries Targeted</span>
  </div>
  <div class="rf-stat-card">
    <span class="rf-stat-number"><%= total %></span>
    <span class="rf-stat-label">Total Claims</span>
  </div>
  <div class="rf-stat-card">
    <span class="rf-stat-number"><%= items.length %></span>
    <span class="rf-stat-label">Showing</span>
  </div>
</div>

<!-- Top groups bar -->
<% if (!activeGroup) { %>
  <%
    var groupCounts = {};
    items.forEach(function(i) { if (i.group) groupCounts[i.group] = (groupCounts[i.group] || 0) + 1; });
    var topGroups = Object.entries(groupCounts).sort(function(a,b) { return b[1] - a[1]; }).slice(0, 15);
  %>
  <% if (topGroups.length > 0) { %>
    <div class="rf-top-groups">
      <h3 class="rf-section-title">Top Ransomware Groups</h3>
      <div class="rf-group-tags">
        <% topGroups.forEach(function(g) { %>
          <a href="/ransomfeed?group=<%= encodeURIComponent(g[0]) %>" class="rf-group-tag">
            <span class="rf-group-tag-name"><%= g[0] %></span>
            <span class="rf-group-tag-count"><%= g[1] %></span>
          </a>
        <% }); %>
      </div>
    </div>
  <% } %>
<% } %>

<!-- Claims table -->
<div class="rf-table-wrapper">
  <table class="rf-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Victim</th>
        <th>Group</th>
        <th>Country</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      <% if (items.length === 0) { %>
        <tr><td colspan="5" class="rf-empty">No ransomware claims found<%= (activeGroup || activeCountry) ? ' matching your filters' : '' %>.</td></tr>
      <% } else { %>
        <% items.forEach(function(item) { %>
          <tr>
            <td class="rf-cell-date">
              <% if (item.pubDate) { %>
                <%= new Date(item.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
              <% } else { %>
                &mdash;
              <% } %>
            </td>
            <td class="rf-cell-victim">
              <span class="rf-victim-name"><%= item.victim || item.title %></span>
            </td>
            <td class="rf-cell-group">
              <% if (item.group) { %>
                <a href="/ransomfeed?group=<%= encodeURIComponent(item.group) %>" class="rf-group-badge"><%= item.group %></a>
              <% } else { %>
                <span class="rf-unknown">Unknown</span>
              <% } %>
            </td>
            <td class="rf-cell-country">
              <% if (item.country) { %>
                <a href="/ransomfeed?country=<%= encodeURIComponent(item.country) %>" class="rf-country-badge"><%= item.country %></a>
              <% } else { %>
                <span class="rf-unknown">&mdash;</span>
              <% } %>
            </td>
            <td class="rf-cell-link">
              <% if (item.link) { %>
                <a href="<%= item.link %>" target="_blank" rel="noopener noreferrer" class="rf-detail-link">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </a>
              <% } %>
            </td>
          </tr>
        <% }); %>
      <% } %>
    </tbody>
  </table>
</div>

<div class="rf-attribution">
  Data source: <a href="https://ransomfeed.it" target="_blank" rel="noopener noreferrer">ransomfeed.it</a> by Dario Fadda, licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a>
</div>

<script>
function applyFilters() {
  var group = document.getElementById('rf-group-filter').value;
  var country = document.getElementById('rf-country-filter').value;
  var params = [];
  if (group) params.push('group=' + encodeURIComponent(group));
  if (country) params.push('country=' + encodeURIComponent(country));
  window.location.href = '/ransomfeed' + (params.length ? '?' + params.join('&') : '');
}
</script>

<%- include('partials/footer') %>
