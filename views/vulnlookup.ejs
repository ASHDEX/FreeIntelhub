<%- include('partials/head', { pageTitle: 'Vulnerability & Exploit Lookup' }) %>

<!-- Hero search section â€” vertically centered before results, collapses after -->
<div id="vuln-hero" class="vuln-hero">
  <div class="vuln-hero-inner">
    <div class="vuln-hero-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    </div>
    <h1 class="vuln-hero-title">Vulnerability & Exploit Lookup</h1>
    <p class="vuln-hero-subtitle">Search any CVE across 40+ vulnerability databases, exploit repositories, and threat intel sources.</p>

    <div class="vuln-search-box">
      <div class="vuln-search-wrapper">
        <svg class="vuln-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="vuln-search-input" placeholder="Enter CVE ID (e.g. CVE-2024-21887)..." autocomplete="off" spellcheck="false" value="<%= typeof query !== 'undefined' ? query : '' %>">
        <button id="vuln-search-btn" class="vuln-search-btn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </button>
      </div>
      <div id="vuln-suggestions" class="vuln-suggestions"></div>
      <p class="vuln-search-hint">Type a CVE ID like <code>CVE-2024-3400</code> or <code>CVE-2023-44228</code> &mdash; press Enter to search</p>
      <!-- Search history chips -->
      <div id="vuln-history" class="vuln-history" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- Recent / Trending CVEs grid (shown before search) -->
<div id="vuln-recent" class="vuln-recent-section">
  <div class="vuln-recent-header">
    <h2 class="vuln-recent-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>
      Latest Published CVEs
    </h2>
  </div>
  <div id="vuln-recent-grid" class="vuln-recent-grid">
    <div class="vuln-recent-loading">Loading latest CVEs...</div>
  </div>
</div>

<!-- Loading state -->
<div id="vuln-loading" class="vuln-loading" style="display:none;">
  <div class="vuln-spinner"></div>
  <p id="vuln-loading-text">Querying NVD, MITRE, GitHub Advisory, OSV.dev, CISA KEV, EPSS and more...</p>
  <div class="vuln-loading-sources" id="vuln-loading-sources">
    <span class="vuln-loading-chip">NVD</span>
    <span class="vuln-loading-chip">OSV.dev</span>
    <span class="vuln-loading-chip">GitHub</span>
    <span class="vuln-loading-chip">CISA KEV</span>
    <span class="vuln-loading-chip">EPSS</span>
  </div>
</div>

<!-- Error state -->
<div id="vuln-error" class="vuln-error" style="display:none;"></div>

<!-- Results container -->
<div id="vuln-results" style="display:none;">

  <!-- ===== 1. CVE Overview Card ===== -->
  <div id="vuln-header-card" class="vuln-card vuln-header-card"></div>

  <!-- ===== 2. EPSS Score Card ===== -->
  <div id="vuln-epss-card" class="vuln-card vuln-epss-card" style="display:none;"></div>

  <!-- ===== 3. CVSS Breakdown ===== -->
  <div id="vuln-cvss-breakdown" class="vuln-card" style="display:none;"></div>

  <!-- ===== 4. Exploitation & PoC Status Panel ===== -->
  <div class="vuln-panel vuln-panel-status">
    <h2 class="vuln-panel-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Exploitation & PoC Status
    </h2>
    <div id="vuln-exploit-status" class="vuln-status-grid"></div>
  </div>

  <!-- ===== 5. CISA KEV details ===== -->
  <div id="vuln-cisa" class="vuln-card vuln-cisa-card" style="display:none;"></div>

  <!-- ===== 5b. Threat Intelligence Panel ===== -->
  <div id="vuln-threat-intel" class="vuln-panel vuln-panel-threat" style="display:none;">
    <h2 class="vuln-panel-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><circle cx="12" cy="16" r="0.5"/></svg>
      Threat Intelligence
    </h2>

    <!-- Threat Actor stat bar -->
    <div id="threat-stats" class="threat-stats-bar"></div>

    <!-- Threat Actors -->
    <h3 class="vuln-subsection-title">Associated Threat Actors</h3>
    <div id="threat-actors" class="threat-actor-grid"></div>

    <!-- Industry Sector Heatmap -->
    <h3 class="vuln-subsection-title">Industry Sector Targeting Heatmap</h3>
    <div class="threat-heatmap-legend">
      <span class="threat-legend-label">Impact:</span>
      <span class="threat-legend-item"><span class="threat-heat-swatch threat-heat-bg-0"></span>None</span>
      <span class="threat-legend-item"><span class="threat-heat-swatch threat-heat-bg-1"></span>Low</span>
      <span class="threat-legend-item"><span class="threat-heat-swatch threat-heat-bg-2"></span>Medium</span>
      <span class="threat-legend-item"><span class="threat-heat-swatch threat-heat-bg-3"></span>High</span>
      <span class="threat-legend-item"><span class="threat-heat-swatch threat-heat-bg-4"></span>Very High</span>
      <span class="threat-legend-item"><span class="threat-heat-swatch threat-heat-bg-5"></span>Critical</span>
    </div>
    <div id="threat-heatmap" class="threat-heatmap-grid"></div>

    <!-- Known Incidents / Breaches -->
    <h3 class="vuln-subsection-title">Known Security Incidents & Breaches</h3>
    <div id="threat-incidents" class="threat-incidents-list"></div>
  </div>

  <!-- ===== 6. Source Results ===== -->
  <div class="vuln-panel">
    <h2 class="vuln-panel-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
      Source Results
    </h2>
    <div id="vuln-source-cards" class="vuln-source-grid"></div>
  </div>

  <!-- ===== 7. Affected Packages ===== -->
  <div id="vuln-affected" class="vuln-card" style="display:none;">
    <h3 class="vuln-card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
      Affected Packages
    </h3>
    <div id="vuln-affected-list"></div>
  </div>

  <!-- ===== 8. References ===== -->
  <div id="vuln-references" class="vuln-card" style="display:none;">
    <h3 class="vuln-card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      References
    </h3>
    <div id="vuln-refs-list"></div>
  </div>

  <!-- ===== 9. External Database Links ===== -->
  <div class="vuln-panel vuln-panel-links">
    <h2 class="vuln-panel-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      Lookup in 40+ Databases
    </h2>

    <h3 class="vuln-subsection-title">Vulnerability Databases</h3>
    <div id="vuln-db-links" class="vuln-link-grid"></div>

    <h3 class="vuln-subsection-title">Exploit & PoC Databases</h3>
    <div id="vuln-exploit-links" class="vuln-link-grid"></div>
  </div>

</div>

<script>
(function() {
  var hero = document.getElementById('vuln-hero');
  var input = document.getElementById('vuln-search-input');
  var btn = document.getElementById('vuln-search-btn');
  var sugBox = document.getElementById('vuln-suggestions');
  var loading = document.getElementById('vuln-loading');
  var errorEl = document.getElementById('vuln-error');
  var results = document.getElementById('vuln-results');
  var recentSection = document.getElementById('vuln-recent');
  var historyEl = document.getElementById('vuln-history');

  var CVE_RE = /^CVE-\d{4}-\d{4,}$/i;
  var PARTIAL_RE = /^(C|CV|CVE|CVE-|CVE-\d{0,4}|CVE-\d{4}-|CVE-\d{4}-\d{0,})$/i;
  var debounce = null;

  function escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  // ===== Search History (localStorage) =====
  var HISTORY_KEY = 'vuln_search_history';
  var MAX_HISTORY = 8;

  function getHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
    catch (e) { return []; }
  }

  function addToHistory(cveId, severity) {
    var history = getHistory();
    history = history.filter(function(h) { return h.id !== cveId; });
    history.unshift({ id: cveId, severity: severity || '', time: Date.now() });
    if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); } catch (e) {}
    renderHistory();
  }

  function renderHistory() {
    var history = getHistory();
    if (history.length === 0) { historyEl.style.display = 'none'; return; }
    historyEl.style.display = 'flex';
    var html = '<span class="vuln-history-label">Recent:</span>';
    history.forEach(function(h) {
      var sevClass = h.severity ? ' vuln-hist-' + h.severity.toLowerCase() : '';
      html += '<button class="vuln-history-chip' + sevClass + '" data-cve="' + escHtml(h.id) + '">' + escHtml(h.id) + '</button>';
    });
    historyEl.innerHTML = html;
  }

  historyEl.addEventListener('click', function(e) {
    var chip = e.target.closest('[data-cve]');
    if (chip) {
      input.value = chip.getAttribute('data-cve');
      btn.disabled = false;
      sugBox.style.display = 'none';
      doLookup(chip.getAttribute('data-cve'));
    }
  });

  renderHistory();

  // ===== Recent CVEs on page load =====
  function loadRecentCVEs() {
    fetch('/api/cves')
      .then(function(r) { return r.json(); })
      .then(function(cves) {
        if (!cves || cves.length === 0) {
          document.getElementById('vuln-recent-grid').innerHTML = '<p class="vuln-recent-empty">No recent CVEs available.</p>';
          return;
        }
        var html = cves.slice(0, 9).map(function(c) {
          var sevClass = c.severity ? 'vuln-severity-' + c.severity.toLowerCase() : '';
          var sevBadge = c.severity
            ? '<span class="vuln-severity-badge vuln-recent-sev ' + sevClass + '">' + escHtml(c.severity) + '</span>'
            : '';
          return '<div class="vuln-recent-card" data-cve="' + escHtml(c.id) + '">'
            + '<div class="vuln-recent-card-top">'
            + '<span class="vuln-recent-card-id">' + escHtml(c.id) + '</span>'
            + sevBadge
            + '</div>'
            + '<p class="vuln-recent-card-desc">' + escHtml(c.description || 'No description available.') + '</p>'
            + '</div>';
        }).join('');
        document.getElementById('vuln-recent-grid').innerHTML = html;
      })
      .catch(function() {
        document.getElementById('vuln-recent-grid').innerHTML = '<p class="vuln-recent-empty">Could not load recent CVEs.</p>';
      });
  }

  // Click on recent CVE card
  document.getElementById('vuln-recent-grid').addEventListener('click', function(e) {
    var card = e.target.closest('[data-cve]');
    if (card) {
      input.value = card.getAttribute('data-cve');
      btn.disabled = false;
      doLookup(card.getAttribute('data-cve'));
    }
  });

  // ===== CVSS Vector Parsing =====
  var CVSS_LABELS = {
    AV: { name: 'Attack Vector', N: 'Network', A: 'Adjacent', L: 'Local', P: 'Physical' },
    AC: { name: 'Attack Complexity', L: 'Low', H: 'High' },
    PR: { name: 'Privileges Required', N: 'None', L: 'Low', H: 'High' },
    UI: { name: 'User Interaction', N: 'None', R: 'Required' },
    S:  { name: 'Scope', U: 'Unchanged', C: 'Changed' },
    C:  { name: 'Confidentiality', N: 'None', L: 'Low', H: 'High' },
    I:  { name: 'Integrity', N: 'None', L: 'Low', H: 'High' },
    A:  { name: 'Availability', N: 'None', L: 'Low', H: 'High' },
  };

  var CVSS_DANGER = {
    AV: { N: 'high', A: 'medium', L: 'low', P: 'low' },
    AC: { L: 'high', H: 'low' },
    PR: { N: 'high', L: 'medium', H: 'low' },
    UI: { N: 'high', R: 'low' },
    S:  { C: 'high', U: 'low' },
    C:  { H: 'high', L: 'medium', N: 'low' },
    I:  { H: 'high', L: 'medium', N: 'low' },
    A:  { H: 'high', L: 'medium', N: 'low' },
  };

  function parseCVSSVector(vector) {
    if (!vector || !vector.includes('/')) return null;
    var parts = vector.split('/');
    var metrics = [];
    parts.forEach(function(part) {
      var kv = part.split(':');
      if (kv.length === 2 && CVSS_LABELS[kv[0]]) {
        var key = kv[0], val = kv[1];
        var info = CVSS_LABELS[key];
        var danger = (CVSS_DANGER[key] && CVSS_DANGER[key][val]) || 'low';
        metrics.push({
          key: key,
          name: info.name,
          value: info[val] || val,
          code: val,
          danger: danger,
        });
      }
    });
    return metrics.length > 0 ? metrics : null;
  }

  // ===== Input validation and suggestions =====
  input.addEventListener('input', function() {
    var v = input.value.trim();
    btn.disabled = !CVE_RE.test(v);

    clearTimeout(debounce);
    if (v.length === 0) { sugBox.innerHTML = ''; sugBox.style.display = 'none'; return; }

    if (CVE_RE.test(v)) {
      sugBox.innerHTML = '<div class="vuln-sug-item vuln-sug-valid" tabindex="0" data-cve="' + escHtml(v.toUpperCase()) + '">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>'
        + '<span>Lookup <strong>' + escHtml(v.toUpperCase()) + '</strong></span>'
        + '<span class="vuln-sug-hint">Press Enter</span>'
        + '</div>';
      sugBox.style.display = 'block';
    } else if (PARTIAL_RE.test(v)) {
      sugBox.innerHTML = '<div class="vuln-sug-item vuln-sug-typing">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>'
        + '<span>Keep typing... <code>CVE-YYYY-NNNNN</code></span>'
        + '</div>';
      sugBox.style.display = 'block';

      debounce = setTimeout(function() {
        if (/^CVE-\d{4}-\d{1,}$/i.test(v)) {
          fetchSuggestions(v.toUpperCase());
        }
      }, 300);
    } else {
      sugBox.innerHTML = '<div class="vuln-sug-item vuln-sug-invalid">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
        + '<span>Invalid format. Use <code>CVE-YYYY-NNNNN</code></span>'
        + '</div>';
      sugBox.style.display = 'block';
    }
  });

  function fetchSuggestions(partial) {
    fetch('/api/cves')
      .then(function(r) { return r.json(); })
      .then(function(cves) {
        var matches = cves.filter(function(c) {
          return c.id && c.id.startsWith(partial);
        }).slice(0, 5);
        if (matches.length === 0) return;
        var html = matches.map(function(c) {
          var sevClass = c.severity ? ' vuln-sev-' + c.severity.toLowerCase() : '';
          return '<div class="vuln-sug-item vuln-sug-cve" tabindex="0" data-cve="' + escHtml(c.id) + '">'
            + '<span class="vuln-sug-cve-id">' + escHtml(c.id) + '</span>'
            + (c.severity ? '<span class="vuln-sug-sev' + sevClass + '">' + escHtml(c.severity) + '</span>' : '')
            + '<span class="vuln-sug-desc">' + escHtml(c.description || '') + '</span>'
            + '</div>';
        }).join('');
        sugBox.innerHTML = sugBox.innerHTML + html;
      })
      .catch(function() {});
  }

  // Click on suggestion
  sugBox.addEventListener('click', function(e) {
    var item = e.target.closest('[data-cve]');
    if (item) {
      input.value = item.getAttribute('data-cve');
      btn.disabled = false;
      sugBox.style.display = 'none';
      doLookup(item.getAttribute('data-cve'));
    }
  });

  // Enter key
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      var v = input.value.trim();
      if (CVE_RE.test(v)) {
        sugBox.style.display = 'none';
        doLookup(v.toUpperCase());
      }
    }
  });

  btn.addEventListener('click', function() {
    var v = input.value.trim();
    if (CVE_RE.test(v)) {
      sugBox.style.display = 'none';
      doLookup(v.toUpperCase());
    }
  });

  // Close suggestions on outside click
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.vuln-search-box')) { sugBox.style.display = 'none'; }
  });

  // ===== Copy to clipboard helper =====
  function copyToClipboard(text, btnEl) {
    navigator.clipboard.writeText(text).then(function() {
      btnEl.classList.add('vuln-copied');
      btnEl.setAttribute('title', 'Copied!');
      setTimeout(function() {
        btnEl.classList.remove('vuln-copied');
        btnEl.setAttribute('title', 'Copy CVE ID');
      }, 1500);
    }).catch(function() {});
  }

  // ===== Main Lookup =====
  function doLookup(cveId) {
    // Collapse hero to compact mode
    hero.classList.add('vuln-hero-compact');
    recentSection.style.display = 'none';
    loading.style.display = 'flex';
    errorEl.style.display = 'none';
    results.style.display = 'none';

    history.replaceState(null, '', '/vulnerability?cve=' + encodeURIComponent(cveId));

    fetch('/api/vuln/' + encodeURIComponent(cveId))
      .then(function(r) {
        if (!r.ok) return r.json().then(function(j) { throw new Error(j.error || 'Lookup failed'); });
        return r.json();
      })
      .then(function(json) {
        loading.style.display = 'none';
        addToHistory(json.data.id, json.data.severity);
        renderResults(json.data);
      })
      .catch(function(err) {
        loading.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = '<p>' + escHtml(err.message || 'Something went wrong. Please try again.') + '</p>';
      });
  }

  function renderResults(data) {
    results.style.display = 'block';

    // ===== Header card =====
    var sevClass = data.severity ? 'vuln-severity-' + data.severity.toLowerCase() : '';
    var headerHtml = '<div class="vuln-header-top">'
      + '<a href="' + escHtml(data.link) + '" target="_blank" rel="noopener noreferrer" class="vuln-header-id">' + escHtml(data.id) + '</a>'
      + '<button class="vuln-copy-btn" title="Copy CVE ID" data-copy="' + escHtml(data.id) + '">'
      + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>'
      + '<svg class="vuln-copy-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="m9 12 2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>'
      + '</button>';

    if (data.severity) {
      headerHtml += '<span class="vuln-severity-badge ' + sevClass + '">'
        + escHtml(data.severity) + (data.score ? ' ' + data.score : '') + '</span>';
    }
    headerHtml += '</div>';

    if (data.description) {
      headerHtml += '<p class="vuln-header-desc">' + escHtml(data.description) + '</p>';
    }

    headerHtml += '<div class="vuln-header-meta">';
    if (data.published) headerHtml += '<span><strong>Published:</strong> ' + new Date(data.published).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + '</span>';
    if (data.lastModified) headerHtml += '<span><strong>Modified:</strong> ' + new Date(data.lastModified).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + '</span>';
    if (data.vector) headerHtml += '<span class="vuln-vector"><strong>Vector:</strong> <code>' + escHtml(data.vector) + '</code></span>';
    headerHtml += '</div>';

    if (data.weaknesses && data.weaknesses.length > 0) {
      headerHtml += '<div class="vuln-weaknesses">';
      data.weaknesses.forEach(function(w) {
        headerHtml += '<span class="vuln-cwe-badge">' + escHtml(w) + '</span>';
      });
      headerHtml += '</div>';
    }
    document.getElementById('vuln-header-card').innerHTML = headerHtml;

    // Bind copy button
    var copyBtn = document.querySelector('.vuln-copy-btn[data-copy]');
    if (copyBtn) {
      copyBtn.addEventListener('click', function(e) {
        e.preventDefault();
        copyToClipboard(this.getAttribute('data-copy'), this);
      });
    }

    // ===== EPSS Score Card =====
    var epssCard = document.getElementById('vuln-epss-card');
    if (data.epss) {
      var epssPercent = (data.epss.score * 100).toFixed(2);
      var epssPctile = (data.epss.percentile * 100).toFixed(1);
      var epssLevel = data.epss.score >= 0.1 ? 'high' : data.epss.score >= 0.01 ? 'medium' : 'low';

      epssCard.style.display = 'block';
      epssCard.innerHTML = '<div class="vuln-epss-content">'
        + '<div class="vuln-epss-gauge">'
        + '<div class="vuln-epss-ring vuln-epss-' + epssLevel + '">'
        + '<span class="vuln-epss-number">' + epssPercent + '%</span>'
        + '</div>'
        + '<span class="vuln-epss-gauge-label">EPSS Score</span>'
        + '</div>'
        + '<div class="vuln-epss-details">'
        + '<h3 class="vuln-card-title">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>'
        + 'Exploit Prediction Scoring System (EPSS)'
        + '</h3>'
        + '<p class="vuln-epss-desc">Probability of exploitation in the next 30 days based on FIRST.org EPSS model.</p>'
        + '<div class="vuln-epss-stats">'
        + '<div class="vuln-epss-stat">'
        + '<span class="vuln-epss-stat-label">Exploitation Probability</span>'
        + '<span class="vuln-epss-stat-value vuln-epss-val-' + epssLevel + '">' + epssPercent + '%</span>'
        + '</div>'
        + '<div class="vuln-epss-stat">'
        + '<span class="vuln-epss-stat-label">Percentile Rank</span>'
        + '<span class="vuln-epss-stat-value">' + epssPctile + '%</span>'
        + '</div>'
        + '</div>'
        + '<div class="vuln-epss-bar-container">'
        + '<div class="vuln-epss-bar-bg">'
        + '<div class="vuln-epss-bar-fill vuln-epss-bar-' + epssLevel + '" style="width:' + Math.min(parseFloat(epssPctile), 100) + '%"></div>'
        + '</div>'
        + '<span class="vuln-epss-bar-label">Higher than ' + epssPctile + '% of all CVEs</span>'
        + '</div>'
        + '</div>'
        + '</div>';
    } else {
      epssCard.style.display = 'none';
    }

    // ===== CVSS Vector Breakdown =====
    var cvssEl = document.getElementById('vuln-cvss-breakdown');
    var metrics = parseCVSSVector(data.vector);
    if (metrics) {
      cvssEl.style.display = 'block';
      var cvssHtml = '<h3 class="vuln-card-title">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>'
        + 'CVSS Vector Breakdown'
        + '</h3>'
        + '<div class="vuln-cvss-grid">';
      metrics.forEach(function(m) {
        cvssHtml += '<div class="vuln-cvss-metric">'
          + '<span class="vuln-cvss-metric-label">' + escHtml(m.name) + '</span>'
          + '<span class="vuln-cvss-metric-value vuln-cvss-' + m.danger + '">' + escHtml(m.value) + '</span>'
          + '</div>';
      });
      cvssHtml += '</div>';
      cvssEl.innerHTML = cvssHtml;
    } else {
      cvssEl.style.display = 'none';
    }

    // ===== Exploitation & PoC status =====
    var statusHtml = '';

    // EPSS quick status (if available)
    if (data.epss) {
      var eLvl = data.epss.score >= 0.1 ? 'vuln-status-danger' : data.epss.score >= 0.01 ? 'vuln-status-warn' : 'vuln-status-safe';
      var eLabel = data.epss.score >= 0.1 ? 'HIGH risk of exploitation' : data.epss.score >= 0.01 ? 'MODERATE risk of exploitation' : 'LOW risk of exploitation';
      statusHtml += '<div class="vuln-status-card ' + eLvl + '">'
        + '<div class="vuln-status-icon">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>'
        + '</div>'
        + '<div class="vuln-status-text">'
        + '<span class="vuln-status-label">EPSS (30-day Exploit Probability)</span>'
        + '<span class="vuln-status-value">' + (data.epss.score * 100).toFixed(2) + '% &mdash; ' + eLabel + '</span>'
        + '</div>'
        + '</div>';
    }


    // Exploited in the wild
    statusHtml += '<div class="vuln-status-card ' + (data.exploitedInWild ? 'vuln-status-danger' : 'vuln-status-safe') + '">'
      + '<div class="vuln-status-icon">'
      + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">'
      + (data.exploitedInWild
        ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'
        : '<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>')
      + '</svg>'
      + '</div>'
      + '<div class="vuln-status-text">'
      + '<span class="vuln-status-label">Exploited in the Wild</span>'
      + '<span class="vuln-status-value">' + (data.exploitedInWild ? 'YES &mdash; Listed in CISA KEV' : 'Not in CISA Known Exploited Vulnerabilities') + '</span>'
      + '</div>'
      + '</div>';

    // PoC / Exploit presence
    statusHtml += '<div class="vuln-status-card ' + (data.hasKnownExploit ? 'vuln-status-warn' : 'vuln-status-safe') + '">'
      + '<div class="vuln-status-icon">'
      + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">'
      + (data.hasKnownExploit
        ? '<path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>'
        : '<circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>')
      + '</svg>'
      + '</div>'
      + '<div class="vuln-status-text">'
      + '<span class="vuln-status-label">PoC / Exploit Available</span>'
      + '<span class="vuln-status-value">' + (data.hasKnownExploit ? 'YES &mdash; Public exploit or PoC references found' : 'No known public PoC or exploit references') + '</span>'
      + '</div>'
      + '</div>';

    // Ransomware use (from CISA KEV)
    if (data.cisaKev) {
      var ransomware = data.cisaKev.knownRansomwareCampaignUse || 'Unknown';
      var isRansomware = ransomware.toLowerCase() === 'known';
      statusHtml += '<div class="vuln-status-card ' + (isRansomware ? 'vuln-status-danger' : 'vuln-status-neutral') + '">'
        + '<div class="vuln-status-icon">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'
        + '</div>'
        + '<div class="vuln-status-text">'
        + '<span class="vuln-status-label">Ransomware Campaign Use</span>'
        + '<span class="vuln-status-value">' + escHtml(ransomware) + '</span>'
        + '</div>'
        + '</div>';
    }

    document.getElementById('vuln-exploit-status').innerHTML = statusHtml;

    // ===== CISA KEV details =====
    var cisaEl = document.getElementById('vuln-cisa');
    if (data.cisaKev) {
      var k = data.cisaKev;
      cisaEl.style.display = 'block';
      cisaEl.innerHTML = '<h3 class="vuln-card-title vuln-cisa-title">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>'
        + 'CISA Known Exploited Vulnerability'
        + '</h3>'
        + '<div class="vuln-cisa-grid">'
        + '<div class="vuln-cisa-field"><span class="vuln-cisa-key">Vendor</span><span class="vuln-cisa-val">' + escHtml(k.vendorProject) + '</span></div>'
        + '<div class="vuln-cisa-field"><span class="vuln-cisa-key">Product</span><span class="vuln-cisa-val">' + escHtml(k.product) + '</span></div>'
        + '<div class="vuln-cisa-field"><span class="vuln-cisa-key">Date Added</span><span class="vuln-cisa-val">' + escHtml(k.dateAdded) + '</span></div>'
        + '<div class="vuln-cisa-field"><span class="vuln-cisa-key">Due Date</span><span class="vuln-cisa-val">' + escHtml(k.dueDate) + '</span></div>'
        + '</div>'
        + '<p class="vuln-cisa-desc">' + escHtml(k.shortDescription) + '</p>'
        + (k.requiredAction ? '<div class="vuln-cisa-action"><strong>Required Action:</strong> ' + escHtml(k.requiredAction) + '</div>' : '');
    } else {
      cisaEl.style.display = 'none';
    }

    // ===== Threat Intelligence Panel =====
    var threatPanel = document.getElementById('vuln-threat-intel');
    if (data.threatIntel) {
      var ti = data.threatIntel;
      threatPanel.style.display = 'block';

      // Stats bar
      var statsHtml = '<div class="threat-stat-item">'
        + '<span class="threat-stat-number">' + ti.actorCount + '</span>'
        + '<span class="threat-stat-label">Threat Actor' + (ti.actorCount !== 1 ? 's' : '') + '</span>'
        + '</div>'
        + '<div class="threat-stat-item">'
        + '<span class="threat-stat-number">' + ti.incidentCount + '</span>'
        + '<span class="threat-stat-label">Known Incident' + (ti.incidentCount !== 1 ? 's' : '') + '</span>'
        + '</div>'
        + '<div class="threat-stat-item">'
        + '<span class="threat-stat-number">' + ti.sectorHeatmap.filter(function(s) { return s.level > 0; }).length + '</span>'
        + '<span class="threat-stat-label">Sectors Targeted</span>'
        + '</div>'
        + '<div class="threat-stat-item">'
        + '<span class="threat-stat-number">' + ti.origins.length + '</span>'
        + '<span class="threat-stat-label">Origin' + (ti.origins.length !== 1 ? 's' : '') + '</span>'
        + '</div>';
      if (ti.vulnName) {
        statsHtml = '<div class="threat-stat-item threat-stat-name">'
          + '<span class="threat-stat-label">Common Name</span>'
          + '<span class="threat-stat-number threat-stat-vulnname">' + escHtml(ti.vulnName) + '</span>'
          + '</div>' + statsHtml;
      }
      document.getElementById('threat-stats').innerHTML = statsHtml;

      // Threat Actor cards
      var actorHtml = ti.actors.map(function(a) {
        var motivClass = '';
        if (/ransomware|financial|extortion/i.test(a.motivation)) motivClass = 'threat-motiv-financial';
        else if (/espionage/i.test(a.motivation)) motivClass = 'threat-motiv-espionage';
        else if (/pre-position/i.test(a.motivation)) motivClass = 'threat-motiv-preposition';

        return '<div class="threat-actor-card">'
          + '<div class="threat-actor-header">'
          + '<span class="threat-actor-name">' + escHtml(a.name) + '</span>'
          + '<span class="threat-actor-origin">' + escHtml(a.origin) + '</span>'
          + '</div>'
          + (a.aliases && a.aliases.length > 0
            ? '<div class="threat-actor-aliases">Also: ' + a.aliases.map(function(al) { return escHtml(al); }).join(', ') + '</div>'
            : '')
          + '<div class="threat-actor-meta">'
          + '<span class="threat-actor-motiv ' + motivClass + '">' + escHtml(a.motivation) + '</span>'
          + (a.first_seen ? '<span class="threat-actor-seen">First seen: ' + escHtml(a.first_seen) + '</span>' : '')
          + '</div>'
          + '</div>';
      }).join('');
      document.getElementById('threat-actors').innerHTML = actorHtml;

      // Heatmap
      var heatHtml = ti.sectorHeatmap.map(function(s) {
        return '<div class="threat-heat-cell threat-heat-' + s.level + '">'
          + '<span class="threat-heat-sector">' + escHtml(s.sector) + '</span>'
          + '<span class="threat-heat-level">' + s.level + '/5</span>'
          + '</div>';
      }).join('');
      document.getElementById('threat-heatmap').innerHTML = heatHtml;

      // Incidents
      var incHtml = ti.incidents.map(function(inc) {
        var typeClass = '';
        if (/breach/i.test(inc.type)) typeClass = 'threat-inc-breach';
        else if (/mass/i.test(inc.type)) typeClass = 'threat-inc-mass';
        else if (/espionage|zero.day/i.test(inc.type)) typeClass = 'threat-inc-espionage';
        else typeClass = 'threat-inc-other';

        return '<div class="threat-incident-card ' + typeClass + '">'
          + '<div class="threat-inc-header">'
          + '<span class="threat-inc-name">' + escHtml(inc.name) + '</span>'
          + '<span class="threat-inc-date">' + escHtml(inc.date) + '</span>'
          + '</div>'
          + '<span class="threat-inc-type">' + escHtml(inc.type) + '</span>'
          + '<p class="threat-inc-impact">' + escHtml(inc.impact) + '</p>'
          + '</div>';
      }).join('');
      document.getElementById('threat-incidents').innerHTML = incHtml;
    } else {
      threatPanel.style.display = 'none';
    }


    // ===== Source result cards =====
    var sourceHtml = '';
    var sources = data.sources;
    var sourceList = [
      { key: 'nvd', name: 'NIST NVD', icon: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>' },
      { key: 'osv', name: 'OSV.dev', icon: '<circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>' },
      { key: 'github', name: 'GitHub Advisory', icon: '<path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>' },
      { key: 'cisa_kev', name: 'CISA KEV', icon: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>' },
    ];
    sourceList.forEach(function(s) {
      var src = sources[s.key];
      var found = src && src.status === 'found';
      sourceHtml += '<div class="vuln-source-card ' + (found ? 'vuln-source-found' : 'vuln-source-miss') + '">'
        + '<div class="vuln-source-header">'
        + '<div class="vuln-source-name-row">'
        + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">' + s.icon + '</svg>'
        + '<span class="vuln-source-name">' + escHtml(s.name) + '</span>'
        + '</div>'
        + '<span class="vuln-source-badge ' + (found ? 'vuln-badge-found' : 'vuln-badge-miss') + '">' + (found ? 'Found' : 'Not Found') + '</span>'
        + '</div>';
      if (found && s.key === 'osv' && src.data) {
        sourceHtml += '<p class="vuln-source-detail">' + escHtml(src.data.summary || src.data.details || '') + '</p>';
        if (src.data.osv_id) sourceHtml += '<span class="vuln-source-id">' + escHtml(src.data.osv_id) + '</span>';
      }
      if (found && s.key === 'github' && src.data) {
        sourceHtml += '<p class="vuln-source-detail">' + escHtml(src.data.summary || '') + '</p>';
        if (src.data.ghsa_id) sourceHtml += '<a href="' + escHtml(src.data.html_url) + '" target="_blank" rel="noopener noreferrer" class="vuln-source-id">' + escHtml(src.data.ghsa_id) + '</a>';
      }
      if (found && s.key === 'cisa_kev' && src.data) {
        sourceHtml += '<p class="vuln-source-detail">' + escHtml(src.data.shortDescription || '') + '</p>';
      }
      sourceHtml += '</div>';
    });
    document.getElementById('vuln-source-cards').innerHTML = sourceHtml;

    // ===== Affected packages =====
    var affectedEl = document.getElementById('vuln-affected');
    var affectedList = document.getElementById('vuln-affected-list');
    var packages = [];
    if (sources.osv && sources.osv.status === 'found' && sources.osv.data && sources.osv.data.affected) {
      sources.osv.data.affected.forEach(function(a) { if (a.package) packages.push(a.package); });
    }
    if (sources.github && sources.github.status === 'found' && sources.github.data && sources.github.data.vulnerabilities) {
      sources.github.data.vulnerabilities.forEach(function(v) {
        if (v.package) packages.push(v.package + (v.vulnerable_range ? ' ' + v.vulnerable_range : '') + (v.patched ? ' (patched: ' + v.patched + ')' : ''));
      });
    }
    if (packages.length > 0) {
      affectedEl.style.display = 'block';
      affectedList.innerHTML = packages.map(function(p) {
        return '<div class="vuln-affected-item"><code>' + escHtml(typeof p === 'string' ? p : JSON.stringify(p)) + '</code></div>';
      }).join('');
    } else {
      affectedEl.style.display = 'none';
    }

    // ===== References =====
    var refsEl = document.getElementById('vuln-references');
    var refsList = document.getElementById('vuln-refs-list');
    if (data.references && data.references.length > 0) {
      refsEl.style.display = 'block';
      refsList.innerHTML = data.references.map(function(r) {
        return '<a href="' + escHtml(r.url) + '" target="_blank" rel="noopener noreferrer" class="vuln-ref-item">'
          + '<span class="vuln-ref-source">' + escHtml(r.source || new URL(r.url).hostname) + '</span>'
          + '<span class="vuln-ref-url">' + escHtml(r.url) + '</span>'
          + '</a>';
      }).join('');
    } else {
      refsEl.style.display = 'none';
    }

    // ===== External links =====
    var links = data.externalLinks;
    if (links) {
      var dbHtml = links.vulnerability_databases.map(function(l) {
        var catClass = 'vuln-link-' + l.category;
        return '<a href="' + escHtml(l.url) + '" target="_blank" rel="noopener noreferrer" class="vuln-ext-link ' + catClass + '">'
          + '<span class="vuln-ext-name">' + escHtml(l.name) + '</span>'
          + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>'
          + '</a>';
      }).join('');
      document.getElementById('vuln-db-links').innerHTML = dbHtml;

      var exHtml = links.exploit_databases.map(function(l) {
        return '<a href="' + escHtml(l.url) + '" target="_blank" rel="noopener noreferrer" class="vuln-ext-link vuln-link-exploit">'
          + '<span class="vuln-ext-name">' + escHtml(l.name) + '</span>'
          + '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>'
          + '</a>';
      }).join('');
      document.getElementById('vuln-exploit-links').innerHTML = exHtml;
    }

    // Scroll to results
    document.getElementById('vuln-header-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Auto-lookup from URL param
  var params = new URLSearchParams(window.location.search);
  var cvePre = params.get('cve');
  if (cvePre && CVE_RE.test(cvePre)) {
    input.value = cvePre.toUpperCase();
    btn.disabled = false;
    doLookup(cvePre.toUpperCase());
  } else {
    // Only load recent CVEs if not doing an auto-lookup
    loadRecentCVEs();
  }
})();
</script>

<%- include('partials/footer') %>
