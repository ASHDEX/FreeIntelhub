<%- include('partials/head', { pageTitle: 'IOC Lookup' }) %>

<div class="page-header">
  <h1>IOC Lookup</h1>
  <p>Look up IPs, domains, hashes, and URLs against threat intelligence providers. Your API keys are stored locally in your browser and never saved on the server.</p>
</div>

<!-- API Keys Configuration -->
<details class="lookup-keys-panel" id="keys-panel">
  <summary class="lookup-keys-toggle">API Keys <span class="keys-status" id="keys-status"></span></summary>
  <div class="lookup-keys-body">
    <p class="form-hint" style="margin-bottom: 1rem;">Keys are stored in your browser's localStorage. They are sent with each lookup and immediately discarded by the server.</p>
    <div class="lookup-keys-grid">
      <div class="lookup-key-field">
        <label>VirusTotal</label>
        <input type="password" id="key-virustotal" placeholder="Enter API key" autocomplete="off" spellcheck="false">
        <span class="form-hint">Free tier: 4 lookups/min &mdash; <a href="https://www.virustotal.com/gui/my-apikey" target="_blank" rel="noopener noreferrer">Get key</a></span>
      </div>
      <div class="lookup-key-field">
        <label>AbuseIPDB</label>
        <input type="password" id="key-abuseipdb" placeholder="Enter API key" autocomplete="off" spellcheck="false">
        <span class="form-hint">Free tier: 1000 lookups/day &mdash; <a href="https://www.abuseipdb.com/account/api" target="_blank" rel="noopener noreferrer">Get key</a></span>
      </div>
      <div class="lookup-key-field">
        <label>ThreatFox</label>
        <span class="badge badge-source" style="font-size:0.65rem;">No key needed</span>
      </div>
      <div class="lookup-key-field">
        <label>MalwareBazaar</label>
        <span class="badge badge-source" style="font-size:0.65rem;">No key needed</span>
      </div>
    </div>
    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
      <button class="btn btn-accent" onclick="saveKeys()">Save Keys</button>
      <button class="btn" style="background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-muted);" onclick="clearKeys()">Clear All Keys</button>
    </div>
  </div>
</details>

<!-- Lookup Form -->
<div class="lookup-form-wrapper">
  <form id="lookup-form" onsubmit="return doLookup(event)">
    <div class="lookup-input-row">
      <div class="lookup-input-wrap">
        <svg class="lookup-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="lookup-ioc" placeholder="Enter IP, domain, hash (MD5/SHA1/SHA256), or URL..." autocomplete="off" spellcheck="false" required>
      </div>
      <button type="submit" class="btn btn-accent" id="lookup-btn">Lookup</button>
    </div>
    <div class="lookup-providers-row">
      <label class="checkbox-label"><input type="checkbox" id="prov-virustotal" checked> VirusTotal</label>
      <label class="checkbox-label"><input type="checkbox" id="prov-abuseipdb" checked> AbuseIPDB</label>
      <label class="checkbox-label"><input type="checkbox" id="prov-threatfox" checked> ThreatFox</label>
      <label class="checkbox-label"><input type="checkbox" id="prov-malwarebazaar" checked> MalwareBazaar</label>
    </div>
  </form>
</div>

<!-- Detected Type -->
<div id="lookup-type-badge" class="lookup-type-badge" style="display:none;"></div>

<!-- Loading -->
<div id="lookup-loading" class="lookup-loading" style="display:none;">
  <div class="lookup-spinner"></div>
  <span>Querying threat intelligence providers...</span>
</div>

<!-- Error -->
<div id="lookup-error" class="alert alert-err" style="display:none;"></div>

<!-- Results -->
<div id="lookup-results" style="display:none;"></div>

<script>
// --- Key Management (localStorage only) ---
var KEY_STORAGE = 'fih_ti_keys';

function getStoredKeys() {
  try { return JSON.parse(localStorage.getItem(KEY_STORAGE)) || {}; } catch(_) { return {}; }
}

function saveKeys() {
  var keys = {
    virustotal: document.getElementById('key-virustotal').value.trim(),
    abuseipdb: document.getElementById('key-abuseipdb').value.trim(),
  };
  // Remove empty keys
  Object.keys(keys).forEach(function(k) { if (!keys[k]) delete keys[k]; });
  localStorage.setItem(KEY_STORAGE, JSON.stringify(keys));
  updateKeysStatus();
}

function clearKeys() {
  localStorage.removeItem(KEY_STORAGE);
  document.getElementById('key-virustotal').value = '';
  document.getElementById('key-abuseipdb').value = '';
  updateKeysStatus();
}

function loadKeys() {
  var keys = getStoredKeys();
  if (keys.virustotal) document.getElementById('key-virustotal').value = keys.virustotal;
  if (keys.abuseipdb) document.getElementById('key-abuseipdb').value = keys.abuseipdb;
  updateKeysStatus();
}

function updateKeysStatus() {
  var keys = getStoredKeys();
  var count = Object.keys(keys).length;
  var el = document.getElementById('keys-status');
  if (count > 0) {
    el.textContent = count + ' key' + (count > 1 ? 's' : '') + ' saved';
    el.className = 'keys-status keys-status-ok';
  } else {
    el.textContent = 'No keys configured';
    el.className = 'keys-status';
  }
}

// --- IOC type detection (client-side for instant feedback) ---
function detectType(val) {
  if (/^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/.test(val)) return 'ip';
  if (/^[a-fA-F0-9]{64}$/.test(val)) return 'hash (SHA256)';
  if (/^[a-fA-F0-9]{40}$/.test(val)) return 'hash (SHA1)';
  if (/^[a-fA-F0-9]{32}$/.test(val)) return 'hash (MD5)';
  if (/^https?:\/\/.+/i.test(val)) return 'url';
  if (/^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/.test(val)) return 'domain';
  return null;
}

// --- Lookup ---
function doLookup(e) {
  e.preventDefault();
  var ioc = document.getElementById('lookup-ioc').value.trim();
  if (!ioc) return false;

  var keys = getStoredKeys();
  var providers = [];
  if (document.getElementById('prov-virustotal').checked) providers.push('virustotal');
  if (document.getElementById('prov-abuseipdb').checked) providers.push('abuseipdb');
  if (document.getElementById('prov-threatfox').checked) providers.push('threatfox');
  if (document.getElementById('prov-malwarebazaar').checked) providers.push('malwarebazaar');

  if (!providers.length) { showError('Select at least one provider.'); return false; }

  // Show loading
  document.getElementById('lookup-loading').style.display = 'flex';
  document.getElementById('lookup-results').style.display = 'none';
  document.getElementById('lookup-error').style.display = 'none';
  document.getElementById('lookup-btn').disabled = true;

  // Show type badge
  var type = detectType(ioc);
  var typeBadge = document.getElementById('lookup-type-badge');
  if (type) {
    typeBadge.textContent = 'Detected type: ' + type;
    typeBadge.style.display = 'inline-block';
  } else {
    typeBadge.style.display = 'none';
  }

  fetch('/api/lookup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ioc: ioc, keys: keys, providers: providers })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    document.getElementById('lookup-loading').style.display = 'none';
    document.getElementById('lookup-btn').disabled = false;

    if (data.error) { showError(data.error); return; }
    renderResults(data);
  })
  .catch(function(err) {
    document.getElementById('lookup-loading').style.display = 'none';
    document.getElementById('lookup-btn').disabled = false;
    showError('Network error: ' + err.message);
  });

  return false;
}

function showError(msg) {
  var el = document.getElementById('lookup-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function renderResults(data) {
  var container = document.getElementById('lookup-results');
  if (!data.results || !data.results.length) {
    container.innerHTML = '<p class="empty">No results returned.</p>';
    container.style.display = 'block';
    return;
  }

  var html = '<div class="lookup-results-grid">';

  data.results.forEach(function(r) {
    html += '<div class="lookup-result-card' + (r.error ? ' lookup-result-error' : '') + '">';
    html += '<div class="lookup-result-header">';
    html += '<strong>' + esc(r.provider || 'Unknown') + '</strong>';
    if (r.link) html += '<a href="' + esc(r.link) + '" target="_blank" rel="noopener noreferrer" class="btn-sm">View &rarr;</a>';
    html += '</div>';

    if (r.error) {
      html += '<p class="lookup-result-err">' + esc(r.error) + '</p>';
    } else if (r.found === false) {
      html += '<p class="lookup-result-clean">Not found in database</p>';
    } else {
      html += '<div class="lookup-result-body">';
      html += renderProviderResult(r);
      html += '</div>';
    }

    html += '</div>';
  });

  html += '</div>';
  container.innerHTML = html;
  container.style.display = 'block';
}

function renderProviderResult(r) {
  var html = '';

  if (r.provider === 'VirusTotal') {
    var ratio = r.malicious + '/' + r.total;
    var severity = r.malicious === 0 ? 'clean' : (r.malicious >= 5 ? 'danger' : 'warn');
    html += '<div class="lookup-verdict lookup-verdict-' + severity + '">';
    html += '<span class="lookup-verdict-num">' + r.malicious + '</span>';
    html += '<span>/' + r.total + ' detections</span>';
    html += '</div>';
    if (r.threat_label) html += row('Threat', r.threat_label);
    if (r.name) html += row('Name', r.name);
    if (r.country) html += row('Country', r.country);
    if (r.as_owner) html += row('AS Owner', r.as_owner);
    if (r.reputation !== undefined) html += row('Reputation', r.reputation);
    if (r.tags && r.tags.length) html += row('Tags', r.tags.map(function(t) { return '<span class="badge badge-ioc">' + esc(t) + '</span>'; }).join(' '));
    if (r.last_analysis) html += row('Last Analysis', new Date(r.last_analysis).toLocaleDateString());
  }

  else if (r.provider === 'AbuseIPDB') {
    var pct = r.abuse_confidence || 0;
    var severity = pct === 0 ? 'clean' : (pct >= 50 ? 'danger' : 'warn');
    html += '<div class="lookup-verdict lookup-verdict-' + severity + '">';
    html += '<span class="lookup-verdict-num">' + pct + '%</span>';
    html += '<span>abuse confidence</span>';
    html += '</div>';
    if (r.total_reports !== undefined) html += row('Total Reports', r.total_reports);
    if (r.country) html += row('Country', r.country);
    if (r.isp) html += row('ISP', r.isp);
    if (r.domain) html += row('Domain', r.domain);
    if (r.usage_type) html += row('Usage', r.usage_type);
    if (r.is_tor) html += row('Tor Exit', 'Yes');
    if (r.last_reported) html += row('Last Reported', new Date(r.last_reported).toLocaleDateString());
  }

  else if (r.provider === 'ThreatFox') {
    html += '<div class="lookup-verdict lookup-verdict-danger">';
    html += '<span class="lookup-verdict-num">!</span>';
    html += '<span>Found in ThreatFox (' + (r.total_matches || 1) + ' match' + ((r.total_matches || 1) > 1 ? 'es' : '') + ')</span>';
    html += '</div>';
    if (r.malware) html += row('Malware', r.malware);
    if (r.threat_type) html += row('Threat Type', r.threat_type);
    if (r.confidence_level !== undefined) html += row('Confidence', r.confidence_level + '%');
    if (r.tags && r.tags.length) html += row('Tags', r.tags.map(function(t) { return '<span class="badge badge-ioc">' + esc(t) + '</span>'; }).join(' '));
    if (r.first_seen) html += row('First Seen', r.first_seen);
    if (r.reference) html += row('Reference', '<a href="' + esc(r.reference) + '" target="_blank" rel="noopener noreferrer">' + esc(r.reference.substring(0, 60)) + '</a>');
  }

  else if (r.provider === 'MalwareBazaar') {
    html += '<div class="lookup-verdict lookup-verdict-danger">';
    html += '<span class="lookup-verdict-num">!</span>';
    html += '<span>Found in MalwareBazaar</span>';
    html += '</div>';
    if (r.signature) html += row('Signature', r.signature);
    if (r.file_name) html += row('File Name', r.file_name);
    if (r.file_type) html += row('File Type', r.file_type);
    if (r.file_size) html += row('File Size', formatBytes(r.file_size));
    if (r.tags && r.tags.length) html += row('Tags', r.tags.map(function(t) { return '<span class="badge badge-ioc">' + esc(t) + '</span>'; }).join(' '));
    if (r.first_seen) html += row('First Seen', r.first_seen);
  }

  return html;
}

function row(label, value) {
  return '<div class="lookup-row"><span class="lookup-row-label">' + esc(label) + '</span><span class="lookup-row-value">' + value + '</span></div>';
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

// --- Init ---
loadKeys();

// Live type detection
document.getElementById('lookup-ioc').addEventListener('input', function() {
  var val = this.value.trim();
  var typeBadge = document.getElementById('lookup-type-badge');
  if (val.length >= 3) {
    var type = detectType(val);
    if (type) {
      typeBadge.textContent = 'Detected type: ' + type;
      typeBadge.style.display = 'inline-block';
    } else {
      typeBadge.style.display = 'none';
    }
  } else {
    typeBadge.style.display = 'none';
  }
});
</script>

<%- include('partials/footer') %>
