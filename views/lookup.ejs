<%- include('partials/head', { pageTitle: 'IOC Lookup' }) %>

<div class="page-header">
  <h1>IOC Lookup</h1>
  <p>Look up IPs, domains, hashes, and URLs against threat intelligence providers. Save your keys on the <a href="/keys">API Keys</a> page so they auto-fill here.</p>
</div>

<!-- Provider Cards -->
<div class="provider-cards" id="provider-cards">

  <!-- VirusTotal -->
  <div class="provider-card" id="card-virustotal" data-provider="virustotal">
    <div class="provider-card-header">
      <div class="provider-card-title">
        <strong>VirusTotal</strong>
        <span class="badge badge-source" style="font-size:0.62rem;">API key required</span>
      </div>
      <span class="form-hint" style="margin:0;"><a href="https://www.virustotal.com/gui/my-apikey" target="_blank" rel="noopener noreferrer">Get key</a> &mdash; Free: 4 req/min</span>
    </div>
    <div class="provider-card-body">
      <div class="provider-row">
        <label>IOC</label>
        <div class="provider-input-wrap">
          <svg class="lookup-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" class="ioc-input" placeholder="IP, domain, hash, or URL..." autocomplete="off" spellcheck="false">
        </div>
      </div>
      <div class="provider-row">
        <label>API Key</label>
        <input type="password" class="provider-key" id="key-virustotal" placeholder="Paste VirusTotal API key" autocomplete="off" spellcheck="false">
      </div>
    </div>
    <div class="provider-card-footer">
      <div class="provider-type-badge"></div>
      <button class="btn btn-accent btn-sm-provider" onclick="doSingleLookup('virustotal')">Lookup</button>
    </div>
    <div class="provider-result" id="result-virustotal"></div>
  </div>

  <!-- AbuseIPDB -->
  <div class="provider-card" id="card-abuseipdb" data-provider="abuseipdb">
    <div class="provider-card-header">
      <div class="provider-card-title">
        <strong>AbuseIPDB</strong>
        <span class="badge badge-source" style="font-size:0.62rem;">API key required</span>
      </div>
      <span class="form-hint" style="margin:0;"><a href="https://www.abuseipdb.com/account/api" target="_blank" rel="noopener noreferrer">Get key</a> &mdash; Free: 1000 req/day</span>
    </div>
    <div class="provider-card-body">
      <div class="provider-row">
        <label>IOC</label>
        <div class="provider-input-wrap">
          <svg class="lookup-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" class="ioc-input" placeholder="IP address..." autocomplete="off" spellcheck="false">
        </div>
      </div>
      <div class="provider-row">
        <label>API Key</label>
        <input type="password" class="provider-key" id="key-abuseipdb" placeholder="Paste AbuseIPDB API key" autocomplete="off" spellcheck="false">
      </div>
    </div>
    <div class="provider-card-footer">
      <div class="provider-type-badge"></div>
      <button class="btn btn-accent btn-sm-provider" onclick="doSingleLookup('abuseipdb')">Lookup</button>
    </div>
    <div class="provider-result" id="result-abuseipdb"></div>
  </div>

  <!-- ThreatFox -->
  <div class="provider-card" id="card-threatfox" data-provider="threatfox">
    <div class="provider-card-header">
      <div class="provider-card-title">
        <strong>ThreatFox</strong>
        <span class="badge badge-source" style="font-size:0.62rem;background:var(--green);color:#fff;">No key needed</span>
      </div>
      <span class="form-hint" style="margin:0;">Abuse.ch &mdash; Free, open</span>
    </div>
    <div class="provider-card-body">
      <div class="provider-row">
        <label>IOC</label>
        <div class="provider-input-wrap">
          <svg class="lookup-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" class="ioc-input" placeholder="IP, domain, hash, or URL..." autocomplete="off" spellcheck="false">
        </div>
      </div>
    </div>
    <div class="provider-card-footer">
      <div class="provider-type-badge"></div>
      <button class="btn btn-accent btn-sm-provider" onclick="doSingleLookup('threatfox')">Lookup</button>
    </div>
    <div class="provider-result" id="result-threatfox"></div>
  </div>

  <!-- MalwareBazaar -->
  <div class="provider-card" id="card-malwarebazaar" data-provider="malwarebazaar">
    <div class="provider-card-header">
      <div class="provider-card-title">
        <strong>MalwareBazaar</strong>
        <span class="badge badge-source" style="font-size:0.62rem;background:var(--green);color:#fff;">No key needed</span>
      </div>
      <span class="form-hint" style="margin:0;">Abuse.ch &mdash; Free, open</span>
    </div>
    <div class="provider-card-body">
      <div class="provider-row">
        <label>IOC</label>
        <div class="provider-input-wrap">
          <svg class="lookup-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" class="ioc-input" placeholder="MD5, SHA1, or SHA256 hash..." autocomplete="off" spellcheck="false">
        </div>
      </div>
    </div>
    <div class="provider-card-footer">
      <div class="provider-type-badge"></div>
      <button class="btn btn-accent btn-sm-provider" onclick="doSingleLookup('malwarebazaar')">Lookup</button>
    </div>
    <div class="provider-result" id="result-malwarebazaar"></div>
  </div>

</div>

<!-- Search All banner -->
<div class="lookup-all-banner" id="lookup-all-banner">
  <div class="lookup-all-left">
    <strong>Search all providers at once</strong>
    <span>Enter an IOC in any card above, then click here to query every provider simultaneously.</span>
  </div>
  <button class="btn btn-accent" id="lookup-all-btn" onclick="doAllLookup()">Lookup All</button>
</div>

<!-- Global loading -->
<div id="lookup-loading" class="lookup-loading" style="display:none;">
  <div class="lookup-spinner"></div>
  <span>Querying threat intelligence providers...</span>
</div>

<!-- Global error -->
<div id="lookup-error" class="alert alert-err" style="display:none;"></div>

<script>
var COOKIE_NAME = 'fih_ti_keys';
var ALL_PROVIDERS = ['virustotal', 'abuseipdb', 'threatfox', 'malwarebazaar'];

// --- Cookie reader ---
function getCookie(name) {
  var prefix = name + '=';
  var parts = document.cookie.split(';');
  for (var i = 0; i < parts.length; i++) {
    var c = parts[i].trim();
    if (c.indexOf(prefix) === 0) return decodeURIComponent(c.substring(prefix.length));
  }
  return null;
}

// --- Load saved keys from cookie ---
function loadFromCookie() {
  var raw = getCookie(COOKIE_NAME);
  if (!raw) return;
  try {
    var keys = JSON.parse(atob(raw));
    if (keys.virustotal) document.getElementById('key-virustotal').value = keys.virustotal;
    if (keys.abuseipdb) document.getElementById('key-abuseipdb').value = keys.abuseipdb;
  } catch (_) {}
}

// --- Sync IOC inputs: typing in any card copies the value to all others ---
var iocInputs = document.querySelectorAll('.ioc-input');
iocInputs.forEach(function(inp) {
  inp.addEventListener('input', function() {
    var val = this.value;
    iocInputs.forEach(function(other) {
      if (other !== inp) other.value = val;
    });
    // Update type badges on all cards
    updateAllTypeBadges(val.trim());
  });
});

// --- IOC type detection ---
function detectType(val) {
  if (/^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/.test(val)) return 'ip';
  if (/^[a-fA-F0-9]{64}$/.test(val)) return 'hash (SHA256)';
  if (/^[a-fA-F0-9]{40}$/.test(val)) return 'hash (SHA1)';
  if (/^[a-fA-F0-9]{32}$/.test(val)) return 'hash (MD5)';
  if (/^https?:\/\/.+/i.test(val)) return 'url';
  if (/^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/.test(val)) return 'domain';
  return null;
}

function updateAllTypeBadges(val) {
  var badges = document.querySelectorAll('.provider-type-badge');
  if (val.length >= 3) {
    var type = detectType(val);
    badges.forEach(function(b) {
      if (type) { b.textContent = 'Detected: ' + type; b.style.display = 'inline-block'; }
      else { b.style.display = 'none'; }
    });
  } else {
    badges.forEach(function(b) { b.style.display = 'none'; });
  }
}

// --- Get the IOC value (from the first non-empty input) ---
function getIOC() {
  for (var i = 0; i < iocInputs.length; i++) {
    var v = iocInputs[i].value.trim();
    if (v) return v;
  }
  return '';
}

// --- Get API keys ---
function getKeys() {
  var keys = {};
  var vt = document.getElementById('key-virustotal').value.trim();
  var ab = document.getElementById('key-abuseipdb').value.trim();
  if (vt) keys.virustotal = vt;
  if (ab) keys.abuseipdb = ab;
  return keys;
}

// --- Single provider lookup ---
function doSingleLookup(provider) {
  var ioc = getIOC();
  if (!ioc) { showCardError(provider, 'Enter an IOC value to look up.'); return; }

  var keys = getKeys();
  showCardLoading(provider, true);
  clearCardResult(provider);
  hideGlobalError();

  fetch('/api/lookup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ioc: ioc, keys: keys, providers: [provider] })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    showCardLoading(provider, false);
    if (data.error) { showCardError(provider, data.error); return; }
    if (data.results && data.results.length) {
      renderCardResult(provider, data.results[0]);
    }
  })
  .catch(function(err) {
    showCardLoading(provider, false);
    showCardError(provider, 'Network error: ' + err.message);
  });
}

// --- Lookup All providers ---
function doAllLookup() {
  var ioc = getIOC();
  if (!ioc) { showGlobalError('Enter an IOC in any provider card first.'); return; }

  var keys = getKeys();
  var visibleProviders = [];
  ALL_PROVIDERS.forEach(function(p) {
    var card = document.getElementById('card-' + p);
    if (card && card.style.display !== 'none') visibleProviders.push(p);
  });
  if (!visibleProviders.length) return;

  // Show loading on all visible cards
  visibleProviders.forEach(function(p) {
    showCardLoading(p, true);
    clearCardResult(p);
  });
  hideGlobalError();

  fetch('/api/lookup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ioc: ioc, keys: keys, providers: visibleProviders })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    visibleProviders.forEach(function(p) { showCardLoading(p, false); });
    if (data.error) { showGlobalError(data.error); return; }
    if (data.results) {
      data.results.forEach(function(r) {
        var pid = r.provider ? r.provider.toLowerCase().replace(/\s+/g, '') : '';
        // Map display names back to provider ids
        var nameMap = { 'virustotal': 'virustotal', 'abuseipdb': 'abuseipdb', 'threatfox': 'threatfox', 'malwarebazaar': 'malwarebazaar' };
        var resolvedId = nameMap[pid] || pid;
        renderCardResult(resolvedId, r);
      });
    }
  })
  .catch(function(err) {
    visibleProviders.forEach(function(p) { showCardLoading(p, false); });
    showGlobalError('Network error: ' + err.message);
  });
}

// --- Card UI helpers ---
function showCardLoading(provider, show) {
  var card = document.getElementById('card-' + provider);
  if (!card) return;
  var btn = card.querySelector('.btn-sm-provider');
  if (btn) btn.disabled = show;
  var result = document.getElementById('result-' + provider);
  if (show) {
    result.innerHTML = '<div class="lookup-loading" style="display:flex;padding:1rem 0;"><div class="lookup-spinner"></div><span>Querying...</span></div>';
    result.style.display = 'block';
  }
}

function clearCardResult(provider) {
  var el = document.getElementById('result-' + provider);
  if (el) { el.innerHTML = ''; el.style.display = 'none'; }
}

function showCardError(provider, msg) {
  var el = document.getElementById('result-' + provider);
  if (el) {
    el.innerHTML = '<div class="provider-result-msg provider-result-err">' + esc(msg) + '</div>';
    el.style.display = 'block';
  }
}

function showGlobalError(msg) {
  var el = document.getElementById('lookup-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function hideGlobalError() {
  document.getElementById('lookup-error').style.display = 'none';
}

function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// --- Render result inside a card ---
function renderCardResult(provider, r) {
  var el = document.getElementById('result-' + provider);
  if (!el) return;

  var html = '<div class="provider-result-inner">';

  if (r.error) {
    html += '<div class="provider-result-msg provider-result-err">' + esc(r.error) + '</div>';
  } else if (r.found === false) {
    html += '<div class="provider-result-msg provider-result-clean">Not found in database</div>';
  } else {
    // Header with link
    if (r.link) {
      html += '<div class="provider-result-link"><a href="' + esc(r.link) + '" target="_blank" rel="noopener noreferrer" class="btn-sm">View full report &rarr;</a></div>';
    }
    html += renderProviderResult(r);
  }

  html += '</div>';
  el.innerHTML = html;
  el.style.display = 'block';
}

function renderProviderResult(r) {
  var html = '';

  if (r.provider === 'VirusTotal') {
    var severity = r.malicious === 0 ? 'clean' : (r.malicious >= 5 ? 'danger' : 'warn');
    html += '<div class="lookup-verdict lookup-verdict-' + severity + '">';
    html += '<span class="lookup-verdict-num">' + r.malicious + '</span>';
    html += '<span>/' + r.total + ' detections</span>';
    html += '</div>';
    if (r.threat_label) html += row('Threat', r.threat_label);
    if (r.name) html += row('Name', r.name);
    if (r.country) html += row('Country', r.country);
    if (r.as_owner) html += row('AS Owner', r.as_owner);
    if (r.reputation !== undefined) html += row('Reputation', r.reputation);
    if (r.tags && r.tags.length) html += row('Tags', r.tags.map(function(t) { return '<span class="badge badge-ioc">' + esc(t) + '</span>'; }).join(' '));
    if (r.last_analysis) html += row('Last Analysis', new Date(r.last_analysis).toLocaleDateString());
  }

  else if (r.provider === 'AbuseIPDB') {
    var pct = r.abuse_confidence || 0;
    var severity = pct === 0 ? 'clean' : (pct >= 50 ? 'danger' : 'warn');
    html += '<div class="lookup-verdict lookup-verdict-' + severity + '">';
    html += '<span class="lookup-verdict-num">' + pct + '%</span>';
    html += '<span>abuse confidence</span>';
    html += '</div>';
    if (r.total_reports !== undefined) html += row('Total Reports', r.total_reports);
    if (r.country) html += row('Country', r.country);
    if (r.isp) html += row('ISP', r.isp);
    if (r.domain) html += row('Domain', r.domain);
    if (r.usage_type) html += row('Usage', r.usage_type);
    if (r.is_tor) html += row('Tor Exit', 'Yes');
    if (r.last_reported) html += row('Last Reported', new Date(r.last_reported).toLocaleDateString());
  }

  else if (r.provider === 'ThreatFox') {
    html += '<div class="lookup-verdict lookup-verdict-danger">';
    html += '<span class="lookup-verdict-num">!</span>';
    html += '<span>Found in ThreatFox (' + (r.total_matches || 1) + ' match' + ((r.total_matches || 1) > 1 ? 'es' : '') + ')</span>';
    html += '</div>';
    if (r.malware) html += row('Malware', r.malware);
    if (r.threat_type) html += row('Threat Type', r.threat_type);
    if (r.confidence_level !== undefined) html += row('Confidence', r.confidence_level + '%');
    if (r.tags && r.tags.length) html += row('Tags', r.tags.map(function(t) { return '<span class="badge badge-ioc">' + esc(t) + '</span>'; }).join(' '));
    if (r.first_seen) html += row('First Seen', r.first_seen);
    if (r.reference) html += row('Reference', '<a href="' + esc(r.reference) + '" target="_blank" rel="noopener noreferrer">' + esc(r.reference.substring(0, 60)) + '</a>');
  }

  else if (r.provider === 'MalwareBazaar') {
    html += '<div class="lookup-verdict lookup-verdict-danger">';
    html += '<span class="lookup-verdict-num">!</span>';
    html += '<span>Found in MalwareBazaar</span>';
    html += '</div>';
    if (r.signature) html += row('Signature', r.signature);
    if (r.file_name) html += row('File Name', r.file_name);
    if (r.file_type) html += row('File Type', r.file_type);
    if (r.file_size) html += row('File Size', formatBytes(r.file_size));
    if (r.tags && r.tags.length) html += row('Tags', r.tags.map(function(t) { return '<span class="badge badge-ioc">' + esc(t) + '</span>'; }).join(' '));
    if (r.first_seen) html += row('First Seen', r.first_seen);
  }

  return html;
}

function row(label, value) {
  return '<div class="lookup-row"><span class="lookup-row-label">' + esc(label) + '</span><span class="lookup-row-value">' + value + '</span></div>';
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

// --- Filter: show only the cards matching ?providers= ---
function applyProviderFilter() {
  var params = new URLSearchParams(window.location.search);
  var filter = params.get('providers');
  if (!filter) return; // show all
  var allowed = filter.split(',');
  ALL_PROVIDERS.forEach(function(p) {
    var card = document.getElementById('card-' + p);
    if (card) card.style.display = allowed.indexOf(p) !== -1 ? '' : 'none';
  });
  // If only one provider visible, hide the "Lookup All" banner
  if (allowed.length === 1) {
    document.getElementById('lookup-all-banner').style.display = 'none';
  }
}

// --- Init ---
loadFromCookie();
applyProviderFilter();
</script>

<%- include('partials/footer') %>
